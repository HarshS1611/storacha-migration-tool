"use strict";(()=>{var e={};e.id=535,e.ids=[535],e.modules={5142:e=>{e.exports=require("dotenv")},1239:e=>{e.exports=require("events")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6932:e=>{e.exports=import("@web3-storage/upload-client")},3543:e=>{e.exports=import("@web3-storage/upload-client/fetch-with-upload-progress")},5652:e=>{e.exports=import("@web3-storage/w3up-client")},6705:e=>{e.exports=import("formidable")},4300:e=>{e.exports=require("buffer")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5158:e=>{e.exports=require("http2")},5687:e=>{e.exports=require("https")},4492:e=>{e.exports=require("node:stream")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},7282:e=>{e.exports=require("process")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},5427:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>d,routeModule:()=>c});var i=t(1802),a=t(7153),s=t(6249),n=t(6493),l=e([n]);n=(l.then?(await l)():l)[0];let d=(0,s.l)(n,"default"),u=(0,s.l)(n,"config"),c=new i.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/storacha-upload",pathname:"/api/storacha-upload",bundlePath:"",filename:""},userland:n});o()}catch(e){o(e)}})},6493:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>n});var i=t(6705),a=e([i]);i=(a.then?(await a)():a)[0];let u={api:{bodyParser:!1}};async function s(e){return new Promise(r=>{let t="";e.on("data",e=>{t+=e}),e.on("end",()=>{r(JSON.parse(t))})})}async function n(e,r){try{let o,i,a,n,u,c,p,f;if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});r.setHeader("Content-Type","application/json"),r.setHeader("Connection","keep-alive"),r.setHeader("Cache-Control","no-cache");let g=(e,t,o)=>{r.write(`${JSON.stringify({phase:e,message:t,percentage:o})}
`)};try{if(!(o=(await t.e(241).then(t.bind(t,5241))).StorachaMigrator))throw Error("StorachaMigrator not found in imports")}catch(e){return console.error("Error importing StorachaMigrator:",e),r.status(500).json({error:"Failed to load migration library"})}if(e.headers["content-type"]?.includes("application/json")){let r=await s(e);if(console.log("Received JSON body:",r),i=r.email,a=r.space,n=r.isS3Source,u=r.s3Config,c=r.s3Path,!i)throw Error("Storacha email is required");if(!u)throw Error("S3 configuration is required");if(!c)throw Error("S3 path is required")}else{if(!e.headers["content-type"]?.includes("multipart/form-data"))return r.status(415).json({error:"Unsupported Media Type"});let{fields:t,files:o}=await l(e);if(p=o.file?.[0],i=t.email?.[0],a=t.space?.[0],n=t.isS3Source?.[0]==="true",c=t.s3Path?.[0],!p&&!n)throw Error("No file found in upload");if(!i)throw Error("Storacha email is required")}process.env.STORACHA_EMAIL=i,g("initializing",`Setting up with email: ${i}`,10),g("initializing","Creating StorachaMigrator instance",15);let h=new o({s3:u||{region:process.env.S3_REGION||"us-east-1",bucketName:process.env.S3_BUCKET_NAME||"",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""}},storacha:{email:i},retry:{maxAttempts:3,backoffMs:1e3,maxBackoffMs:1e4},batch:{concurrency:3,size:5}});if(h.onProgress(e=>{let r="";if(e.downloadedBytes&&e.totalDownloadBytes){let t=e.downloadedBytes/e.totalDownloadBytes*100;r+=`Download: ${t.toFixed(1)}% | ${e.downloadSpeed||"0 B/s"} | ${d(e.downloadedBytes)}/${d(e.totalDownloadBytes)}
`}if(e.uploadedBytes&&e.totalUploadBytes){let t=e.uploadedBytes/e.totalUploadBytes*100;r+=`Upload: ${t.toFixed(1)}% | ${e.uploadSpeed||"0 B/s"} | ${d(e.uploadedBytes)}/${d(e.totalUploadBytes)}
`}r+=`
Files: ${e.completedFiles}/${e.totalFiles}
Total Size: ${d(e.totalBytes)}
Processed: ${d(e.bytesUploaded)}
Time Left: ${e.estimatedTimeRemaining||"Calculating..."}
`,void 0!==e.currentShardIndex&&void 0!==e.totalShards&&(r+=`
Processing Shard: ${e.currentShardIndex+1}/${e.totalShards}`);let t=e.uploadedBytes&&e.totalUploadBytes?Math.round(e.uploadedBytes/e.totalUploadBytes*100):void 0;g(void 0!==e.currentShardIndex?"uploading":"preparing",r,t)}),h.onError((e,r)=>{console.error(`
âŒ Error migrating ${r}: ${e.message}`),g("error",`Error migrating ${r}: ${e.message}`,0)}),g("initializing","\uD83D\uDD11 Initializing Storacha client...",10),await h.initialize(),g("initializing","âœ“ Client initialized\n\uD83D\uDCE6 Checking subscription status...",15),a&&(g("initializing",`Setting space: ${a}`,20),await h.setSpace(a)),n&&c)g("migrating",`ðŸ“¤ Starting migration from S3: ${c}`,25),f=await h.migrateFile(c);else if(p);else throw Error("Invalid migration configuration");if(await h.close(),f?.success){let e=`âœ… Migration completed successfully!

ðŸ”— CID: ${f.cid}

ðŸŒ URL: ${f.url}

ðŸ“¦ Size: ${d(f.size||0)}`;return g("completed",e,100),r.status(200).json({success:!0,cid:f.cid,url:f.url,size:f.size,message:e})}throw Error(f?.error||"Unknown error occurred")}catch(e){if(console.error("Error in migration process:",e),!r.writableEnded)return r.status(500).json({error:"Migration failed",message:e instanceof Error?e.message:"Unknown error"})}}async function l(e){let r=(0,i.default)({multiples:!0,keepExtensions:!0,maxFileSize:1073741824});return new Promise((t,o)=>{r.parse(e,(e,r,i)=>{e?o(e):t({fields:r,files:i})})})}function d(e){if(0===e)return"0 B";let r=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,r)).toFixed(2)} ${["B","KB","MB","GB","TB"][r]}`}o()}catch(e){o(e)}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=5427);module.exports=t})();