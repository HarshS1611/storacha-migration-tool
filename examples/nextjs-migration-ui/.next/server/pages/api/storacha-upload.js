"use strict";(()=>{var e={};e.id=535,e.ids=[535],e.modules={9336:e=>{e.exports=require("aws-sdk")},5142:e=>{e.exports=require("dotenv")},1239:e=>{e.exports=require("events")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6932:e=>{e.exports=import("@web3-storage/upload-client")},3543:e=>{e.exports=import("@web3-storage/upload-client/fetch-with-upload-progress")},5652:e=>{e.exports=import("@web3-storage/w3up-client")},6705:e=>{e.exports=import("formidable")},6555:e=>{e.exports=import("uuid")},4300:e=>{e.exports=require("buffer")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5158:e=>{e.exports=require("http2")},5687:e=>{e.exports=require("https")},4492:e=>{e.exports=require("node:stream")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},7282:e=>{e.exports=require("process")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},5427:(e,r,t)=>{t.a(e,async(e,i)=>{try{t.r(r),t.d(r,{config:()=>d,default:()=>c,routeModule:()=>p});var o=t(1802),a=t(7153),s=t(6249),n=t(6493),l=e([n]);n=(l.then?(await l)():l)[0];let c=(0,s.l)(n,"default"),d=(0,s.l)(n,"config"),p=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/storacha-upload",pathname:"/api/storacha-upload",bundlePath:"",filename:""},userland:n});i()}catch(e){i(e)}})},6493:(e,r,t)=>{t.a(e,async(e,i)=>{try{t.r(r),t.d(r,{config:()=>y,default:()=>S});var o=t(7147),a=t.n(o),s=t(1017),n=t.n(s),l=t(2037),c=t.n(l),d=t(6555),p=t(6705),u=t(2781),f=t(9336),g=t.n(f),m=e([d,p]);[d,p]=m.then?(await m)():m;let y={api:{bodyParser:!1}};async function S(e,r){let i;if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});r.setHeader("Content-Type","application/json"),r.setHeader("Connection","keep-alive"),r.setHeader("Cache-Control","no-cache");let o=(e,t,i)=>{r.write(`${JSON.stringify({phase:e,message:t,percentage:i})}
`)};try{if(!(i=(await t.e(241).then(t.bind(t,5241))).StorachaMigrator))throw Error("StorachaMigrator not found in imports")}catch(e){return console.error("Error importing StorachaMigrator:",e),r.status(500).json({error:"Failed to load migration library"})}if(e.headers["content-type"]?.includes("multipart/form-data")){try{o("initializing","Parsing uploaded file",5);let{fields:t,files:s}=await h(e),l=s.file?.[0];if(!l)throw Error("No file found in upload");let p=t.email?.[0],f=t.space?.[0],m=t.isS3Source?.[0]==="true",S=t.s3Path?.[0];if(!p)throw Error("Storacha email is required");process.env.STORACHA_EMAIL=p,o("initializing",`Setting up with email: ${p}`,10),o("initializing","Creating StorachaMigrator instance",15);let y=new i({s3:{region:process.env.S3_REGION||"us-east-1",bucketName:process.env.S3_BUCKET_NAME||"",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""}},storacha:{email:p},retry:{maxAttempts:3,backoffMs:1e3,maxBackoffMs:1e4},batch:{concurrency:3,size:5}});y.onProgress(e=>{let r="";if(e.downloadedBytes&&e.totalDownloadBytes){let t=e.downloadedBytes/e.totalDownloadBytes*100;r+=`Download: ${t.toFixed(1)}% | ${e.downloadSpeed||"0 B/s"} | ${w(e.downloadedBytes)}/${w(e.totalDownloadBytes)}
`}if(e.uploadedBytes&&e.totalUploadBytes){let t=e.uploadedBytes/e.totalUploadBytes*100;r+=`Upload: ${t.toFixed(1)}% | ${e.uploadSpeed||"0 B/s"} | ${w(e.uploadedBytes)}/${w(e.totalUploadBytes)}
`}r+=`
Files: ${e.completedFiles}/${e.totalFiles}
Total Size: ${w(e.totalBytes)}
Processed: ${w(e.bytesUploaded)}
Time Left: ${e.estimatedTimeRemaining||"Calculating..."}
`,void 0!==e.currentShardIndex&&void 0!==e.totalShards&&(r+=`
Processing Shard: ${e.currentShardIndex+1}/${e.totalShards}`);let t=e.uploadedBytes&&e.totalUploadBytes?Math.round(e.uploadedBytes/e.totalUploadBytes*100):void 0;o(void 0!==e.currentShardIndex?"uploading":"preparing",r,t)}),y.onError((e,r)=>{console.error(`
❌ Error migrating ${r}: ${e.message}`),o("error",`Error migrating ${r}: ${e.message}`,0)}),o("initializing","\uD83D\uDD11 Initializing Storacha client...",10),await y.initialize(),o("initializing","✓ Client initialized\n\uD83D\uDCE6 Checking subscription status...",15),f&&(o("initializing",`Setting space: ${f}`,20),await y.setSpace(f));let E=n().join(c().tmpdir(),"storacha-upload-"+(0,d.v4)());await a().promises.mkdir(E,{recursive:!0});try{let e;if(m&&S){o("downloading",`📥 Starting S3 migration from: ${S}`,25);try{await y.verifyS3Access(),o("downloading","✓ S3 access verified",30)}catch(e){throw Error(`S3 access verification failed: ${e.message}`)}if(S.endsWith("/")||S.includes("*"))o("analyzing",`📂 Analyzing directory: ${S}`,35),e=await y.migrateDirectory(S);else{o("downloading",`📄 Downloading file: ${S}`,35);let r=S.split("/").pop()||S,t=n().join(c().tmpdir(),"storacha-upload-"+(0,d.v4)());await a().promises.mkdir(t,{recursive:!0});try{let i=new(g()).S3({region:process.env.S3_REGION||"us-east-1",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""}}),s=await i.getObject({Bucket:process.env.S3_BUCKET_NAME||"",Key:S}).promise();if(!s.Body)throw Error("No file content received from S3");let l=n().join(t,r),c=s.Body;if(Buffer.isBuffer(c))await a().promises.writeFile(l,new Uint8Array(c));else if(c instanceof u.Readable)await new Promise((e,r)=>{let t=a().createWriteStream(l);c.pipe(t).on("finish",()=>e()).on("error",r)});else if("string"==typeof c)await a().promises.writeFile(l,c,"utf8");else throw Error("Unexpected S3 response body type");o("uploading",`📤 Uploading ${r}`,40),e=await y.migrateFile(l)}finally{await a().promises.rm(t,{recursive:!0,force:!0})}}}else{if(o("preparing",`📄 Processing file: ${l.originalFilename}`,30),!a().existsSync(l.filepath))throw Error("Source file does not exist");let r=l.originalFilename||"file",t=a().createReadStream(l.filepath),i=new(g()).S3({region:process.env.S3_REGION||"us-east-1",credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID||"",secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY||""}});o("uploading",`📤 Uploading to S3: ${r}`,35),await i.upload({Bucket:process.env.S3_BUCKET_NAME||"",Key:r,Body:t}).promise(),o("migrating",`📤 Migrating to Storacha: ${r}`,40),e=await y.migrateFile(r),await a().promises.unlink(l.filepath)}if(await y.close(),e.success){let t=`✅ Migration completed successfully!

🔗 CID: ${e.cid}

🌐 URL: ${e.url}

📦 Size: ${w(e.size||0)}`;return o("completed",t,100),r.status(200).json({success:!0,cid:e.cid,url:e.url,size:e.size,message:t})}throw Error(e.error||"Unknown error occurred")}catch(t){try{E&&await a().promises.rm(E,{recursive:!0,force:!0}),l?.filepath&&await a().promises.unlink(l.filepath)}catch(e){console.error("Error during cleanup:",e)}console.error("Migration error:",t);let e=t instanceof Error?t.message:"Unknown error";if(o("error",`❌ Migration failed: ${e}`,0),!r.writableEnded)return r.status(500).json({error:"Migration failed",message:e})}}catch(e){if(console.error("Error in migration process:",e),!r.writableEnded)return r.status(500).json({error:"Migration failed",message:e instanceof Error?e.message:"Unknown error"})}return}return r.status(415).json({error:"Unsupported Media Type"})}async function h(e){let r=(0,p.default)({multiples:!0,keepExtensions:!0,maxFileSize:1073741824});return new Promise((t,i)=>{r.parse(e,(e,r,o)=>{e?i(e):t({fields:r,files:o})})})}function w(e){if(0===e)return"0 B";let r=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,r)).toFixed(2)} ${["B","KB","MB","GB","TB"][r]}`}i()}catch(e){i(e)}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=5427);module.exports=t})();